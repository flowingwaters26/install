#!/bin/bash
# Optimized Trojan Account Deletion Tool
# https://t.me/bio_hazard89

# Color definitions
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'
red='\e[1;31m'

# Performance optimization: get current timestamp once
CURRENT_TIMESTAMP=$(date +%s)

clear
NUMBER_OF_CLIENTS=$(grep -c -E "^#! " "/etc/xray/config.json")

if [[ ${NUMBER_OF_CLIENTS} == '0' ]]; then
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    echo -e "\E[40;1;37m          LIST MEMBER V2RAY TROJAN         \E[0m"
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    echo -e ""
    echo -e "You Don't Have a Trojan Account!"
    echo -e ""
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    read -n 1 -s -r -p "Press any key to back"
    m-trojan
fi

clear
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m          LIST MEMBER V2RAY TROJAN         \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37mNO    USERNAME         EXP DATE     STATUS\E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"

# Initialize arrays and counter for optimized processing
declare -A user_exp_dates
declare -A user_status_map
declare -a user_accounts
counter=1

# Single-pass processing for better performance
while read -r line; do
    user=$(echo "$line" | cut -d ' ' -f 2)
    exp=$(echo "$line" | cut -d ' ' -f 3)
    
    # Check if account is locked efficiently
    if grep -q "^#! $user.*LOCKED" "/etc/xray/config.json"; then
        status="LOCKED"
    else
        status="UNLOCKED"
    fi
    
    # Convert expiration date to timestamp for fast comparison
    if exp_timestamp=$(date -d "$exp" +%s 2>/dev/null); then
        exp_formatted="$exp"
        
        # Calculate days remaining efficiently
        days_remaining=$(( (exp_timestamp - CURRENT_TIMESTAMP) / 86400 ))
        
        # Determine status and color efficiently
        if [[ "$status" == "LOCKED" ]]; then
            status_text="LOCKED"
            color="${PURPLE}"  # Purple for locked accounts
        elif (( days_remaining < 0 )); then
            status_text="EXPIRED"
            color="${RED}"     # Red for expired
        elif (( days_remaining == 0 )); then
            status_text="EXPIRES TODAY"
            color="${YELLOW}"  # Yellow for expiring today
        else
            status_text="ACTIVE"
            color="${GREEN}"   # Green for active accounts
        fi
        
        # Display formatted account info with color coding
        printf "${color}%-5s %-15s %-10s %-10s${NC}\n" \
            "$counter" "$user" "$exp_formatted" "$status_text"
        
        # Store account info for deletion reference
        user_accounts+=("$user")
        user_exp_dates["$user"]="$exp_formatted"
        
        ((counter++))
    fi
done < <(grep -E "^#! " "/etc/xray/config.json" | sort | uniq)

echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m     ENTER TROJAN ACCOUNT NUMBER           \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
read -p "Input Number of Account: " account_number

# Validate input
if [[ -z "$account_number" ]]; then
    echo -e "${red}No input detected!${NC}"
    exit 1
fi

# Validate account number is numeric
if ! [[ "$account_number" =~ ^[0-9]+$ ]]; then
    echo -e "${red}Please enter a valid number!${NC}"
    exit 1
fi

# Get the username based on the selected number
selected_username="${user_accounts[$((account_number - 1))]}"

# Check if the selected account exists
if [[ -z "$selected_username" ]]; then
    echo -e "${red}Account number not found!${NC}"
    exit 1
fi

# Get stored expiration date
selected_exp_date="${user_exp_dates[$selected_username]}"

# Optimized account deletion with error handling
echo -e "${YELLOW}Deleting Trojan account: $selected_username${NC}"

# Get UUID for cleanup
uuid=$(grep -w "^#! $selected_username $selected_exp_date" -A 1 "/etc/xray/config.json" | awk -F'"' '/"id":/ {print $4}' | sort | uniq)

# Delete Trojan account from config
sed -i "/^#! $selected_username $selected_exp_date/,/^},{/d" /etc/xray/config.json

# Clean up database and files efficiently
sed -i "/^### $selected_username/d" /etc/trojan/.trojan.db 2>/dev/null
rm -rf "/etc/trojan/$selected_username" \
       "/etc/kyt/limit/trojan/ip/$selected_username" \
       "/var/www/html/trojan-Trial-${selected_username}.txt" \
       "/var/www/html/trojan-${selected_username}.txt" 2>/dev/null

# Restart Xray service
systemctl restart xray >/dev/null 2>&1

clear
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m       DELETE TROJAN ACCOUNT SUCCESS       \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e ""
echo -e "${NC}Username Info   : $selected_username"
echo -e "${NC}Expired Account : $selected_exp_date"
echo -e "${NC}Process Delete  : Success"
echo -e ""
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e ""
read -n 1 -s -r -p "Press Any Key To Back"
m-trojan
