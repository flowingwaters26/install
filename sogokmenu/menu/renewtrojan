#!/bin/bash
# https://t.me/bio_hazard89

dateFromServer=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
biji=$(date +"%Y-%m-%d" -d "$dateFromServer")
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'
red='\e[1;31m'
green='\e[0;32m'
NC='\e[0m'
BGWHITE='\e[0;100;37m'
green() { echo -e "\\033[32;1m${*}\\033[0m"; }
red() { echo -e "\\033[31;1m${*}\\033[0m"; }

clear
NUMBER_OF_CLIENTS=$(grep -c -E "^#! " "/etc/xray/config.json")

if [[ ${NUMBER_OF_CLIENTS} == '0' ]]; then
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    echo -e "\E[40;1;37m          LIST MEMBER V2RAY TROJN         \E[0m"
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    echo -e ""
    echo -e "You Don't Have a Trojan Account!"
    echo -e ""
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    read -n 1 -s -r -p "Press any key to back"
    m-trojan
fi

clear
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m          LIST MEMBER V2RAY TROJN         \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37mNO    USERNAME         EXP DATE     STATUS\E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"

# Fetch and sort by username (alphabetically)
declare -A user_map
declare -A user_status
declare -a accounts

current_date=$(date +%Y-%m-%d)  # Get current date

counter=1  # Add counter for sequential numbering

while read -r line; do
    user=$(echo "$line" | cut -d ' ' -f 2)
    exp=$(echo "$line" | cut -d ' ' -f 3)
    
    # Check status by searching for "LOCKED" key in configuration
    status=$(grep -w "^#! $user" -A 1 "/etc/xray/config.json" | sort | uniq | grep -o "LOCKED" || echo "UNLOCKED")
    
    user_map["$user"]="$exp"
    user_status["$user"]="$status"
done < <(grep -E "^#! " "/etc/xray/config.json" | sort | uniq)

# Display username, expiration date, and status in sorted order
for user in $(echo "${!user_map[@]}" | tr ' ' '\n' | sort); do
    exp="${user_map[$user]}"
    status="${user_status[$user]}"
    
    # Calculate difference in days between current date and exp date
    exp_timestamp=$(date -d "$exp" +%s)  # Exp date in timestamp format
    current_timestamp=$(date -d "$current_date" +%s)  # Current date in timestamp format
    diff_days=$(( (exp_timestamp - current_timestamp) / 86400 ))  # Calculate difference in days
    
    if [[ $diff_days -le 1 ]]; then
        # If exp is less than or equal to 1 day, color it red
        printf "${RED}%-5s %-15s %-10s %-10s${NC}\n" "$counter" "$user" "$exp" " $status"
    else
        # Display with normal color
        printf "%-5s %-15s %-10s %-10s\n" "$counter" "$user" "$exp" " $status"
    fi
     accounts+=("$user")
    ((counter++))  # Increment counter for next number
done

echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m     ENTER TROJAN ACCOUNT NUMBER           \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
read -p "Input Number of Account: " number

# Input validation
if [[ -z "$number" ]]; then
    echo -e "${red}No input detected!${NC}"
    exit 1
fi

selected_account="${accounts[$((number - 1))]}"

if [[ -z "$selected_account" ]]; then
    echo -e "${red}Account number not found!${NC}"
    exit 1
fi

read -p "Limit IP    : " iplim
read -p "Limit Quota : " Quota
read -p "Expired     : " masaaktif

exp=$(grep -wE "^#! $selected_account" "/etc/xray/config.json" | cut -d ' ' -f 3 | sort | uniq)

if [ ! -e /etc/trojan/ ]; then
mkdir -p /etc/trojan/
fi

if [ -z ${Quota} ]; then
  Quota="0"
fi

if [ -z ${iplim} ]; then
  iplim="0"
fi

if [ -z ${masaaktif} ]; then
  masaaktif="0"
fi

c=$(echo "${Quota}" | sed 's/[^0-9]*//g')
d=$((${c} * 1024 * 1024 * 1024))

if [[ ${c} != "0" ]]; then
  echo "${d}" >/etc/trojan/${selected_account}
fi

if [[ ${iplim} != "0" ]]; then
  echo "${iplim}" > /etc/kyt/limit/trojan/ip/${selected_account}
fi

now=$(date +%Y-%m-%d)
d1=$(date -d "$exp" +%s)
d2=$(date -d "$now" +%s)
exp2=$(( (d1 - d2) / 86400 ))
exp3=$(($exp2 + $masaaktif))
exp4=`date -d "$exp3 days" +"%Y-%m-%d"`
uuid=$(grep -w "^#! $selected_account $exp" -A 1 "/etc/xray/config.json" | awk -F'"' '/"password":/ {print $4}' | sort | uniq)
sed -i "/#! $selected_account/c\#! $selected_account $exp4" /etc/xray/config.json
sed -i "/### $selected_account/c\### $selected_account $exp4 $uuid" /etc/trojan/.trojan.db
systemctl restart xray > /dev/null 2>&1

clear
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m        RENEW TROJN ACCOUNT SUCCESS       \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e ""
echo -e "Username    : $selected_account"
echo -e "Limit IP    : $iplim IP"
echo -e "Limit Quota : $Quota GB"
echo -e "Expired     : $exp4"
echo -e ""
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo ""
read -n 1 -s -r -p "Press any key to back"
m-trojan
