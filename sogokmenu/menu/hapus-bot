#!/bin/bash
# Optimized Telegram Bot Removal Tool
# https://t.me/bio_hazard89

# Color definitions
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
LIGHT='\033[0;37m'

clear

# Optimized progress bar function
show_progress() {
    local task="$1"
    local duration="${2:-3}"
    
    echo -ne "${YELLOW}$task ${CYAN}["
    for ((i = 0; i < 20; i++)); do
        echo -ne "${GREEN}#"
        sleep 0.1
    done
    echo -e "${CYAN}] ${GREEN}✓ Complete${NC}"
    sleep 0.5
}
# Optimized bot removal function with comprehensive cleanup
remove_telegram_bot() {
    echo -e "${YELLOW}Starting Telegram bot removal process...${NC}"
    
    # Stop bot-related services first
    echo -e "${CYAN}Stopping bot services...${NC}"
    local bot_services=("bot" "telegram-bot" "kyt-bot")
    for service in "${bot_services[@]}"; do
        if systemctl is-active --quiet "$service" 2>/dev/null; then
            systemctl stop "$service" >/dev/null 2>&1
            systemctl disable "$service" >/dev/null 2>&1
            echo -e "${GREEN}Stopped service: $service${NC}"
        fi
    done
    
    # Remove bot files from /root directory
    show_progress "Cleaning /root directory" 2
    cd /root 2>/dev/null || return 1
    rm -rf kyt.sh >/dev/null 2>&1
    
    # Remove bot files from /usr/bin directory efficiently
    show_progress "Removing bot executables" 2
    cd /usr/bin 2>/dev/null || return 1
    
    # Define bot-related files for efficient removal
    local bot_files=(
        "kyt" "kyt.zip" "bot" "bot.zip" "bot-backup" 
        "bot-cek-login-ssh" "bot-cek-ss" "bot-cek-tr" 
        "bot-cek-vless" "bot-cek-ws" "bot-member-ssh" 
        "setting.py" "bot-restore" "bot-vps-info"
    )
    
    # Remove all bot files in a single operation for efficiency
    for file in "${bot_files[@]}"; do
        [[ -f "$file" ]] && rm -f "$file" >/dev/null 2>&1
    done
    
    # Remove bot configuration directories
    show_progress "Cleaning configuration directories" 2
    local bot_dirs=(
        "/etc/bot" "/var/lib/bot" "/opt/bot" 
        "/usr/local/bin/bot*" "/home/bot"
    )
    
    for dir in "${bot_dirs[@]}"; do
        [[ -d "$dir" ]] && rm -rf "$dir" >/dev/null 2>&1
    done
    
    # Clean up systemd service files
    show_progress "Removing systemd services" 2
    local service_files=(
        "/etc/systemd/system/bot.service"
        "/etc/systemd/system/telegram-bot.service"
        "/etc/systemd/system/kyt-bot.service"
    )
    
    for service_file in "${service_files[@]}"; do
        [[ -f "$service_file" ]] && rm -f "$service_file" >/dev/null 2>&1
    done
    
    # Reload systemd after service file removal
    systemctl daemon-reload >/dev/null 2>&1
    
    # Clean up cron jobs related to bot
    show_progress "Cleaning cron jobs" 1
    crontab -l 2>/dev/null | grep -v "bot\|kyt" | crontab - >/dev/null 2>&1
    
    # Clean up log files
    show_progress "Removing log files" 1
    find /var/log -name "*bot*" -type f -delete >/dev/null 2>&1
    find /var/log -name "*kyt*" -type f -delete >/dev/null 2>&1
    
    echo -e "${GREEN}Telegram bot removal completed successfully!${NC}"
    return 0
}
# Apply netfilter rules if needed
if command -v netfilter-persistent >/dev/null 2>&1; then
    echo -e "${CYAN}Applying firewall rules...${NC}"
    netfilter-persistent save >/dev/null 2>&1
fi

# Execute bot removal
clear
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e "\E[40;1;37m     TELEGRAM BOT REMOVAL TOOL            \E[0m"
echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e ""

# Confirm removal action
echo -e "${YELLOW}This will completely remove the Telegram bot from your system.${NC}"
echo -e "${RED}Are you sure you want to continue? (y/N)${NC}"
read -p "Enter your choice: " confirm

if [[ "$confirm" =~ ^[Yy]$ ]]; then
    echo -e ""
    if remove_telegram_bot; then
        clear
        echo -e "\e[33m──────────────────────────────────────────\033[0m"
        echo -e "\E[40;1;37m     TELEGRAM BOT REMOVAL SUCCESS         \E[0m"
        echo -e "\e[33m──────────────────────────────────────────\033[0m"
        echo -e ""
        echo -e "${GREEN}✓ Bot services stopped and disabled${NC}"
        echo -e "${GREEN}✓ Bot files and executables removed${NC}"
        echo -e "${GREEN}✓ Configuration directories cleaned${NC}"
        echo -e "${GREEN}✓ Systemd services removed${NC}"
        echo -e "${GREEN}✓ Cron jobs cleaned${NC}"
        echo -e "${GREEN}✓ Log files removed${NC}"
        echo -e ""
        echo -e "${CYAN}Telegram bot has been completely removed from your system.${NC}"
    else
        clear
        echo -e "\e[33m──────────────────────────────────────────\033[0m"
        echo -e "\E[40;1;37m     TELEGRAM BOT REMOVAL FAILED          \E[0m"
        echo -e "\e[33m──────────────────────────────────────────\033[0m"
        echo -e ""
        echo -e "${RED}An error occurred during bot removal.${NC}"
        echo -e "${YELLOW}Please check the system manually.${NC}"
    fi
else
    clear
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    echo -e "\E[40;1;37m     TELEGRAM BOT REMOVAL CANCELLED       \E[0m"
    echo -e "\e[33m──────────────────────────────────────────\033[0m"
    echo -e ""
    echo -e "${YELLOW}Bot removal operation cancelled by user.${NC}"
fi

echo -e "\e[33m──────────────────────────────────────────\033[0m"
echo -e ""
read -n 1 -s -r -p "Press [ Enter ] to return to menu"
menu